<div class="pos">
  <!-- Success overlay: reward moment after sale, then redirect to sales list -->
  <div *ngIf="showSaleSuccess()" class="sale-success-overlay" role="alert" aria-live="polite">
    <div class="sale-success-card">
      <div class="sale-success-icon-wrap">
        <mat-icon class="sale-success-icon">check_circle</mat-icon>
      </div>
      <h2 class="sale-success-title">Sale completed!</h2>
      <p class="sale-success-message">Congrats</p>
      <p class="sale-success-hint">Redirecting to sales list in a moment…</p>
    </div>
  </div>

  <!-- Header -->
  <header class="pos-header-bar">
    <div class="header-left">
      <h1 class="pos-title">POS</h1>
      <mat-icon class="header-branch-icon">store</mat-icon>
      <span class="branch-badge">{{ branchContext.currentBranch?.name || 'No Branch' }}</span>
      </div>
    <div class="header-actions ">
      <button mat-stroked-button (click)="clearCart(); goToStep(0)" [disabled]="cart().length === 0" color="warn">
        Clear Sale
      </button>
    </div>
  </header>

  <!-- Branch Warning -->
  <mat-card *ngIf="!isBranchValid()" class="pos-warning-card">
    <mat-card-content class="pos-warning-content">
      <mat-icon color="warn">warning</mat-icon>
      <span>Select a valid branch to continue</span>
    </mat-card-content>
  </mat-card>

  <main class="pos-main" [class.disabled]="!isBranchValid()">
    <div class="pos-main-inner">
    <!-- Stepper: mobile-first pill design with clear progress -->
    <nav class="pos-stepper" role="tablist" aria-label="POS steps">
      <button type="button" (click)="goToStep(0)" [attr.aria-current]="currentStep() === 0 ? 'step' : null"
        [class.pos-stepper-step--active]="currentStep() === 0" [class.pos-stepper-step--done]="currentStep() > 0"
        class="pos-stepper-step">
        <span class="pos-stepper-num" *ngIf="currentStep() <= 0">1</span>
        <mat-icon class="pos-stepper-check" *ngIf="currentStep() > 0">check_circle</mat-icon>
        <span class="pos-stepper-label">Products</span>
      </button>
      <span class="pos-stepper-line" [class.pos-stepper-line--done]="currentStep() > 0"></span>
      <button type="button" (click)="goToStep(1)" [attr.aria-current]="currentStep() === 1 ? 'step' : null"
        [class.pos-stepper-step--active]="currentStep() === 1" [class.pos-stepper-step--done]="currentStep() > 1"
        [disabled]="cart().length === 0" class="pos-stepper-step">
        <span class="pos-stepper-num" *ngIf="currentStep() <= 1">2</span>
        <mat-icon class="pos-stepper-check" *ngIf="currentStep() > 1">check_circle</mat-icon>
        <span class="pos-stepper-label">Cart</span>
      </button>
      <span class="pos-stepper-line" [class.pos-stepper-line--done]="currentStep() > 1"></span>
      <button type="button" (click)="goToStep(2)" [attr.aria-current]="currentStep() === 2 ? 'step' : null"
        [class.pos-stepper-step--active]="currentStep() === 2" [disabled]="cart().length === 0"
        class="pos-stepper-step">
        <span class="pos-stepper-num">3</span>
        <span class="pos-stepper-label">Checkout</span>
      </button>
    </nav>

    <!-- Step 1: Products – mobile-optimized search and add -->
    <section *ngIf="currentStep() === 0" class="pos-step pos-step-products">
      <div class="pos-step-hero">
        <h2 class="pos-step-title">Add products</h2>
        <p class="pos-step-desc">Search by name.</p>
      </div>

        <mat-form-field  class="">
          <mat-label>product search</mat-label>
          <input matInput
            [ngModel]="productSearchInput()"
            (ngModelChange)="productSearchInput.set($event); onProductSearchChange()"
            (keydown)="onProductSearchKeyPress($event)"
            autocomplete="off">
          <mat-icon matPrefix>search</mat-icon>
          <button mat-icon-button matSuffix *ngIf="productSearchInput()" (click)="productSearchInput.set(''); clearSearchResults()" type="button" aria-label="Clear search">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

      <div *ngIf="showSearchResults()" class="pos-results-panel">
        <div *ngIf="isSearching()" class="pos-results-loading">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Searching...</span>
        </div>
        <div *ngIf="!isSearching() && searchResults().length === 0" class="pos-results-empty">
          <mat-icon>inventory_2</mat-icon>
          <span>No products found</span>
        </div>
        <div *ngIf="!isSearching() && searchResults().length > 0" class="pos-results-list">
          <button type="button" *ngFor="let r of searchResults(); let i = index"
            (click)="selectProductFromSearch(r)"
            [class.pos-result-item--selected]="isSearchResultSelected(i)"
            class="pos-result-item">
            <div class="pos-result-body">
              <span class="pos-result-name">{{ r.product.name }}</span>
              <span *ngIf="r.product.genericName" class="pos-result-variant">{{ r.product.genericName }}</span>
              <span *ngIf="r.hasMultipleBatches && r.inventoryItems[0]?.batchNumber" class="pos-result-batch">Batch: {{ r.inventoryItems[0].batchNumber }}</span>
              <div class="pos-result-meta">
                <span class="pos-result-stock">
                  <mat-icon class="pos-result-meta-icon">inventory_2</mat-icon>
                  {{ r.totalQuantity }} in stock
                </span>
                <span *ngIf="r.inventoryItems[0]?.sellingPrice" class="pos-result-price">
                  <mat-icon class="pos-result-meta-icon">payments</mat-icon>
                  KES {{ r.inventoryItems[0].sellingPrice | number:'1.0-0' }}
                </span>
              </div>
              <div *ngIf="r.totalQuantity === 0 && r.otherBranchesBreakdown?.length" class="pos-result-infobite">
                <mat-icon class="pos-result-infobite-icon">info</mat-icon>
                <span>0 at your branch · <ng-container *ngFor="let b of r.otherBranchesBreakdown; let last = last">{{ b.quantity }} in {{ b.branchName }}<ng-container *ngIf="!last">, </ng-container></ng-container></span>
              </div>
            </div>
          </button>
        </div>
      </div>

      <div *ngIf="cart().length > 0" class="pos-cart-preview">
        <div class="pos-cart-preview-head">
          <span class="pos-cart-preview-title">Total item ({{ cart().length }})</span>
          <button type="button" class="pos-cart-preview-see-all" (click)="goToStep(1)">See all</button>
        </div>
        <div class="pos-cart-preview-chips">
          <span *ngFor="let item of cart()" class="pos-cart-chip">{{ item.productName }}</span>
        </div>
      </div>
<!---->
      <div class="flex justify-between w-full rounded  p-2">
        <div class="pos-step-footer-info">
          <span class="pos-step-footer-count">{{ cart().length }} item{{ cart().length !== 1 ? 's' : '' }}</span>
          <span class="pos-step-footer-total">KES {{ totalAmount() | number:'1.0-0' }}</span>
        </div>
        <button mat-raised-button color="primary" type="button" (click)="nextStep()" [disabled]="cart().length === 0" class="btn-continue">
          Continue
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </section>

    <!-- Step 2: Cart – item cards with +/- qty and bill summary -->
    <section *ngIf="currentStep() === 1" class="pos-step pos-step-cart">
      <div class="pos-step-hero">
        <h2 class="pos-step-title">Shopping cart</h2>
        <p class="pos-step-desc" *ngIf="cart().length > 0">{{ cart().length }} item{{ cart().length !== 1 ? 's' : '' }} in your cart</p>
      </div>

      <div *ngIf="cart().length > 0" class="pos-cart-list">
        <div *ngFor="let item of cart(); trackBy: trackCartItemById" class="pos-cart-item">
          <div class="pos-cart-item-main">
            <span class="pos-cart-item-name">{{ item.productName }}</span>
            <div class="pos-cart-item-qty">
              <button type="button" class="pos-qty-btn" (click)="decrementCartItemQuantity(item)" [attr.aria-label]="'Decrease quantity of ' + item.productName">
                <mat-icon>remove</mat-icon>
              </button>
              <span class="pos-qty-value">{{ item.quantity | number:'2.0-0' }}</span>
              <button type="button" class="pos-qty-btn" (click)="incrementCartItemQuantity(item)" [disabled]="item.quantity >= getAvailableStock(item)" [attr.aria-label]="'Increase quantity of ' + item.productName">
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </div>
          <div class="pos-cart-item-right">
            <span class="pos-cart-item-total">KES {{ (item.unitPrice * item.quantity) | number:'1.0-0' }}</span>
            <button type="button" class="pos-cart-item-remove" (click)="removeCartItem(item.id)" aria-label="Remove from cart">
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="cart().length > 0" class="pos-cart-edit-price">
        <span class="pos-cart-edit-label">Edit price</span>
        <div *ngFor="let item of cart(); trackBy: trackCartItemById" class="pos-cart-price-row">
          <span class="pos-cart-price-name">{{ item.productName }}</span>
          <mat-form-field  class="pos-cart-price-field">
            <mat-label>KES</mat-label>
            <input matInput type="number" [(ngModel)]="item.unitPrice" (blur)="updateCartItemPrice(item.id, item.unitPrice)" min="0" step="0.01">
          </mat-form-field>
        </div>
      </div>

      <div *ngIf="cart().length === 0" class="pos-cart-empty">
        <mat-icon>shopping_cart</mat-icon>
        <p>Cart is empty</p>
        <button mat-stroked-button color="primary" type="button" (click)="goToStep(0)">Add products</button>
      </div>

      <div *ngIf="cart().length > 0" class="pos-bill-summary">
        <div class="pos-bill-row">
          <span>Sub total</span>
          <span>KES {{ totalAmount() | number:'1.0-0' }}</span>
        </div>
        <div class="pos-bill-row pos-bill-row--total">
          <span>Total</span>
          <span class="pos-bill-total">KES {{ totalAmount() | number:'1.0-0' }}</span>
        </div>
      </div>

      <div *ngIf="cart().length > 0" class="pos-step-footer flex justify-between">
        <button mat-stroked-button color="primary" type="button" (click)="prevStep()" class="btn-back">
          <mat-icon>arrow_back</mat-icon>
          Back
        </button>
        <button mat-raised-button color="primary" type="button" (click)="nextStep()" class="btn-primary-action">
          Checkout
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </section>

    <!-- Step 3: Checkout – form left, sale summary right on desktop -->
    <section *ngIf="currentStep() === 2" class="pos-checkout">
      <div class="pos-checkout-hero">
        <h2 class="pos-checkout-title">Checkout</h2>
        <p class="pos-checkout-desc">Customer, payment method and confirm.</p>
      </div>

      <div class="pos-checkout-layout">
        <div class="pos-checkout-form">
        <!-- Customer (collapsible) -->
        <div class="pos-checkout-block pos-checkout-customer">
          <button type="button" class="pos-checkout-block-head" (click)="customerDrawerExpanded.set(!customerDrawerExpanded())" [attr.aria-expanded]="customerDrawerExpanded()">
            <mat-icon>person</mat-icon>
            <span class="pos-checkout-block-title">Customer</span>
            <span class="pos-checkout-block-summary" *ngIf="selectedCustomer() && !customerDrawerExpanded()">
              {{ selectedCustomer()!.firstName }} {{ selectedCustomer()!.lastName }}
            </span>
            <span class="pos-checkout-block-spacer"></span>
            <mat-icon class="pos-checkout-block-chevron">{{ customerDrawerExpanded() ? 'expand_less' : 'expand_more' }}</mat-icon>
          </button>
          <div class="pos-checkout-block-body" [class.is-open]="customerDrawerExpanded()">
            <div class="customer-add-fields">
              <mat-form-field appearance="fill" class="pos-input-field full-width">
                <mat-label>Name</mat-label>
                <input matInput [ngModel]="newCustomerName()" (ngModelChange)="newCustomerName.set($event)" placeholder="Customer name">
                <mat-icon matPrefix>person</mat-icon>
              </mat-form-field>
              <mat-form-field appearance="fill" class="pos-input-field full-width">
                <mat-label>Phone</mat-label>
                <input matInput [ngModel]="newCustomerPhone()" (ngModelChange)="newCustomerPhone.set($event)" type="tel" placeholder="Phone number">
                <mat-icon matPrefix>phone</mat-icon>
              </mat-form-field>
              <button mat-raised-button color="primary" type="button" (click)="createNewCustomer()" [disabled]="!newCustomerName().trim() || isCreatingCustomer()">
                <mat-spinner *ngIf="isCreatingCustomer()" diameter="20" class="btn-spinner"></mat-spinner>
                {{ isCreatingCustomer() ? 'Creating...' : 'Add customer' }}
              </button>
            </div>

<!--            <mat-card-content>-->
<!--              <mat-form-field class="search-field"  subscriptSizing="dynamic">-->
<!--                <mat-label>Search customers</mat-label>-->
<!--                <input matInput [(ngModel)]="searchQuery" (ngModelChange)="onSearchChange()" placeholder="Name, phone, or email..." />-->
<!--                <mat-icon matPrefix>search</mat-icon>-->
<!--              </mat-form-field>-->
<!--            </mat-card-content>-->

            <div class="customer-search-panel">
              <mat-form-field  class="full-width ">
                <mat-label>Or search existing customer</mat-label>
                <input matInput
                  [ngModel]="customerSearchInput()"
                  (ngModelChange)="customerSearchInput.set($event); onCustomerSearchChange()"
                  (blur)="onCustomerSearchBlur()"
                  autocomplete="off">
                <mat-icon matPrefix>search</mat-icon>
              </mat-form-field>
              <div *ngIf="showCustomerSearchResults()" class="customer-results">
                <div *ngIf="isCustomerSearching()" class="pos-results-loading">
                  <mat-spinner diameter="24"></mat-spinner>
                  <span>Searching...</span>
                </div>
                <div *ngIf="!isCustomerSearching() && customerSearchResults().length === 0 && hasSearched" class="pos-results-empty">No customers found</div>
                <button type="button" *ngFor="let c of customerSearchResults()"
                  (click)="selectCustomer(c)"
                  [class.selected]="selectedCustomer()?.id === c.id"
                  class="customer-option pos-customer-option">
                  <span class="customer-name">{{ c.firstName }} {{ c.lastName }}</span>
                  <span *ngIf="c.phone" class="customer-phone">{{ c.phone }}</span>
                </button>
              </div>
            </div>
            <div *ngIf="selectedCustomer()" class="customer-selected pos-customer-selected">
              <div>
                <span class="customer-name">{{ selectedCustomer()!.firstName }} {{ selectedCustomer()!.lastName }}</span>
                <span *ngIf="selectedCustomer()!.phone" class="customer-phone">{{ selectedCustomer()!.phone }}</span>
              </div>
              <button mat-icon-button type="button" (click)="clearSelectedCustomer()" aria-label="Clear customer">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <p *ngIf="isCreditSale() && !selectedCustomer()" class="credit-hint">Select or create a customer for credit sale</p>
          </div>
        </div>

        <!-- Payment & Notes -->
        <div class="pos-checkout-block">
          <div class="pos-checkout-block-head static">
            <mat-icon>payment</mat-icon>
            <span class="pos-checkout-block-title">Payment & notes</span>
          </div>
          <div class="pos-checkout-block-body is-open">
            <mat-form-field appearance="fill" class="full-width pos-input-field">
              <mat-label>Payment method</mat-label>
              <mat-select [ngModel]="selectedPaymentMethod()" (ngModelChange)="selectedPaymentMethod.set($event); onPaymentMethodChange()">
                <mat-option *ngFor="let m of paymentMethods" [value]="m">{{ getPaymentMethodDisplayName(m) }}</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-checkbox [ngModel]="isCreditSale()" (ngModelChange)="isCreditSale.set($event); onCreditSaleToggle()">Credit sale</mat-checkbox>
            <div *ngIf="showCreditForm()" class="credit-fields">
              <mat-form-field appearance="fill" class="full-width pos-input-field">
                <mat-label>Amount paid now</mat-label>
                <input matInput type="number" [ngModel]="paymentAmount()" (ngModelChange)="paymentAmount.set($event); recalculateTotals()" min="0" step="0.01">
              </mat-form-field>
              <mat-form-field appearance="fill" class="full-width pos-input-field">
                <mat-label>Expected payment date</mat-label>
                <input matInput [matDatepicker]="expectedPaymentDatePicker" [ngModel]="expectedPaymentDate()" (ngModelChange)="expectedPaymentDate.set($event)">
                <mat-datepicker-toggle matIconSuffix [for]="expectedPaymentDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #expectedPaymentDatePicker></mat-datepicker>
              </mat-form-field>
            </div>
            <mat-form-field appearance="fill" class="full-width pos-input-field notes-field">
              <mat-label>Sale note (optional)</mat-label>
              <textarea matInput [ngModel]="notes()" (ngModelChange)="notes.set($event)" placeholder="Add a note to this sale" rows="2"></textarea>
            </mat-form-field>
          </div>
        </div>
        </div>
        <!-- Sale summary card: right column on desktop, below form on mobile -->
        <aside class="pos-checkout-summary">
          <h3 class="pos-checkout-summary-title">Sale summary</h3>
          <div class="pos-bill-summary-inner">
            <div *ngFor="let item of cart()" class="pos-bill-row">
              <span>{{ item.productName }} × {{ item.quantity }}</span>
              <span>KES {{ (item.unitPrice * item.quantity) | number:'1.0-0' }}</span>
            </div>
            <div class="pos-bill-row pos-bill-row--total">
              <span>Total</span>
              <span class="pos-bill-total">KES {{ totalAmount() | number:'1.0-0' }}</span>
            </div>
            <div *ngIf="selectedCustomer()" class="pos-summary-customer">
              <mat-icon>person</mat-icon>
              <span>{{ selectedCustomer()!.firstName }} {{ selectedCustomer()!.lastName }}</span>
            </div>
            <div *ngIf="isCreditSale()" class="summary-credit-details">
              <div class="credit-details-header">
                <mat-icon>credit_card</mat-icon>
                <span>Credit sale</span>
              </div>
              <div class="credit-detail-row">
                <span>Customer</span>
                <span>{{ selectedCustomer() ? getCustomerDisplayName(selectedCustomer()!) : '—' }}</span>
              </div>
              <div class="credit-detail-row" *ngIf="expectedPaymentDate()">
                <span>Expected payment</span>
                <span>{{ expectedPaymentDate() | date:'mediumDate' }}</span>
              </div>
              <div class="credit-detail-row">
                <span>Upfront</span>
                <span>KES {{ paymentAmount() | number:'1.0-0' }}</span>
              </div>
              <div class="credit-detail-row credit-remaining">
                <span>Remaining</span>
                <span>KES {{ remainingBalance() | number:'1.0-0' }}</span>
              </div>
            </div>
          </div>
          <div class="pos-checkout-actions flex justify-between">
            <button mat-stroked-button color="primary" type="button" (click)="prevStep()" class="btn-back">
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
            <button mat-raised-button type="button" (click)="processSale()" class="btn-primary-action"
              [disabled]="cart().length === 0 || isProcessing()">
              <mat-spinner *ngIf="isProcessing()" diameter="20" class="btn-spinner"></mat-spinner>
              {{ isProcessing() ? 'Processing...' : 'Complete sale' }}
              <mat-icon>check_circle_outline</mat-icon>
            </button>
          </div>
        </aside>
      </div>
    </section>
    </div>
  </main>
</div>
