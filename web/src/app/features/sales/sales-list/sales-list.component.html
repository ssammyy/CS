<div class="sales-list-container">
  <!-- Header -->
  <div class="sales-header">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-semibold text-gray-900">Sales History</h1>
      <div class="flex items-center gap-2 text-sm" [class]="isBranchValid() ? 'text-gray-600' : 'text-red-600'">
        <mat-icon fontIcon="receipt_long" class="text-base"></mat-icon>
        <span>{{ totalElements() }} transactions</span>
        <span *ngIf="!isBranchValid()" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">
          Invalid Context
        </span>
      </div>
    </div>
    <div class="flex items-center gap-3">
    
      
      <button 
        routerLink="/pos"
        class="inline-flex items-center gap-2 px-4 py-2 bg-brand-coral text-white rounded-lg hover:bg-brand-coral/90 transition-colors">
        <mat-icon fontIcon="add" class="text-base"></mat-icon>
        New Sale
      </button>
    </div>
  </div>

  <!-- Branch Context Warning -->
  <div *ngIf="!isBranchValid()" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
    <div class="flex items-center gap-3">
      <mat-icon fontIcon="warning" class="text-red-600"></mat-icon>
      <div>
        <h3 class="text-sm font-medium text-red-800">Invalid Branch Context</h3>
        <p class="text-sm text-red-600">Please select a valid branch to continue with sales operations.</p>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="search-filters" [class.opacity-50]="!isBranchValid()" [class.pointer-events-none]="!isBranchValid()">
    <div class="search-section">
      <div class="search-input">
        <mat-icon fontIcon="search" class="search-icon"></mat-icon>
        <input
          matInput
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange()"
          placeholder="Search by sale number or customer name..."
          class="search-field">
      </div>
    </div>

    <div class="filters-section">
      <div class="filter-group">
        <label class="filter-label">Status:</label>
        <select 
          [(ngModel)]="selectedStatus"
          (ngModelChange)="onFilterChange()"
          class="filter-select">
          <option value="">All Statuses</option>
          <option *ngFor="let status of saleStatuses" [value]="status">
            {{ status }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">Payment Method:</label>
        <select 
          [(ngModel)]="selectedPaymentMethod"
          (ngModelChange)="onFilterChange()"
          class="filter-select">
          <option value="">All Methods</option>
          <option *ngFor="let method of paymentMethods" [value]="method">
            {{ method }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">Start Date:</label>
        <input
          type="date"
          [(ngModel)]="startDate"
          (ngModelChange)="onFilterChange()"
          class="filter-input">
      </div>

      <div class="filter-group">
        <label class="filter-label">End Date:</label>
        <input
          type="date"
          [(ngModel)]="endDate"
          (ngModelChange)="onFilterChange()"
          class="filter-input">
      </div>

      <button 
        (click)="clearFilters()"
        class="clear-filters-btn">
        <mat-icon fontIcon="clear" class="text-base"></mat-icon>
        Clear Filters
      </button>
    </div>
  </div>

  <!-- Sales Table -->
  <div class="sales-table-container" [class.opacity-50]="!isBranchValid()" [class.pointer-events-none]="!isBranchValid()">
    <div *ngIf="loading()" class="loading-state">
      <mat-icon fontIcon="hourglass_empty" class="animate-spin text-4xl text-brand-sky"></mat-icon>
      <p class="text-gray-600">Loading sales...</p>
    </div>

    <div *ngIf="!loading() && sales().length === 0" class="empty-state">
      <mat-icon fontIcon="receipt_long" class="text-6xl text-gray-300"></mat-icon>
      <h3 class="text-lg font-medium text-gray-900">No sales found</h3>
      <p class="text-gray-500">Try adjusting your search criteria or create a new sale.</p>
      <button 
        routerLink="/pos"
        class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-brand-coral text-white rounded-lg hover:bg-brand-coral/90 transition-colors">
        <mat-icon fontIcon="add" class="text-base"></mat-icon>
        Create Sale
      </button>
    </div>

    <div *ngIf="!loading() && sales().length > 0" class="table-wrapper">
      <table mat-table [dataSource]="sales()" class="sales-table">
        <!-- Sale Number Column -->
        <ng-container matColumnDef="saleNumber">
          <th mat-header-cell *matHeaderCellDef>Sale #</th>
          <td mat-cell *matCellDef="let sale">
            <div class="sale-number">
              <span class="font-medium text-brand-sky">{{ sale.saleNumber }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Customer Name Column -->
        <ng-container matColumnDef="customerName">
          <th mat-header-cell *matHeaderCellDef>Customer</th>
          <td mat-cell *matCellDef="let sale">
            <div class="customer-info">
              <span class="customer-name">{{ sale.customerName || 'Walk-in Customer' }}</span>
              <span *ngIf="sale.customerPhone" class="customer-phone">{{ sale.customerPhone }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Total Amount Column -->
        <ng-container matColumnDef="totalAmount">
          <th mat-header-cell *matHeaderCellDef>Total</th>
          <td mat-cell *matCellDef="let sale">
            <span class="total-amount">{{ formatCurrency(sale.totalAmount) }}</span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let sale">
            <div class="status-container">
              <span class="status-badge" [ngClass]="getStatusBadgeClass(sale.status)">
                {{ sale.status }}
              </span>
              <span *ngIf="sale.returnStatus === 'FULL'" class="returned-badge full-return">
                <mat-icon fontIcon="undo" class="returned-icon"></mat-icon>
                Fully Returned
              </span>
              <span *ngIf="sale.returnStatus === 'PARTIAL'" class="returned-badge partial-return">
                <mat-icon fontIcon="undo" class="returned-icon"></mat-icon>
                Partially Returned
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Payment Method Column -->
        <ng-container matColumnDef="paymentMethod">
          <th mat-header-cell *matHeaderCellDef>Payment</th>
          <td mat-cell *matCellDef="let sale">
            <div class="payment-method">
              <mat-icon [fontIcon]="getPaymentMethodIcon(sale.payments[0]?.paymentMethod)" class="payment-icon"></mat-icon>
              <span>{{ sale.payments[0]?.paymentMethod || 'N/A' }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Sale Date Column -->
        <ng-container matColumnDef="saleDate">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let sale">
            <span class="sale-date">{{ formatDate(sale.saleDate) }}</span>
          </td>
        </ng-container>

        <!-- Cashier Name Column -->
        <ng-container matColumnDef="cashierName">
          <th mat-header-cell *matHeaderCellDef>Cashier</th>
          <td mat-cell *matCellDef="let sale">
            <span class="cashier-name">{{ sale.cashierName }}</span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let sale">
            <div class="action-buttons">
              <button 
                (click)="viewSale(sale)"
                class="action-btn view-btn"
                matTooltip="View Details">
                <mat-icon fontIcon="visibility" class="text-sm"></mat-icon>
              </button>
              
              <button 
                (click)="printReceipt(sale)"
                class="action-btn print-btn"
                matTooltip="Print Receipt">
                <mat-icon fontIcon="print" class="text-sm"></mat-icon>
              </button>
              
              <button 
                *ngIf="sale.status === 'COMPLETED'"
                (click)="processReturn(sale)"
                class="action-btn return-btn"
                matTooltip="Process Return">
                <mat-icon fontIcon="undo" class="text-sm"></mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div *ngIf="!loading() && sales().length > 0" class="pagination-container" [class.opacity-50]="!isBranchValid()" [class.pointer-events-none]="!isBranchValid()">
    <mat-paginator
      [length]="totalElements()"
      [pageSize]="pageSize()"
      [pageIndex]="currentPage()"
      [pageSizeOptions]="[10, 20, 50, 100]"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  </div>
</div>
