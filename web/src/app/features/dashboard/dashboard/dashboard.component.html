<div class="min-h-screen bg-gray-50 p-6">
  <!-- Header -->
  <div class="mb-6">
  <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
        <p class="text-gray-600 mt-1">Welcome back, {{ username() }}</p>
      </div>
      <div class="flex items-center gap-3">
        <!-- Branch Selector -->
        <div class="flex items-center gap-2">
          <label class="inline-flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              [(ngModel)]="showAllBranches"
              (change)="toggleAllBranches()"
              class="w-4 h-4 text-brand-sky border-gray-300 rounded focus:ring-brand-sky">
            <span class="text-sm font-medium text-gray-700">All Branches</span>
          </label>
          <mat-form-field *ngIf="!showAllBranches()" class="!w-48">
            <mat-label>Select Branch</mat-label>
            <mat-select [(ngModel)]="selectedBranchId" (selectionChange)="onBranchChange()">
              <mat-option *ngFor="let branch of branches()" [value]="branch.id">
                {{ branch.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Refresh Button -->
        <button
          mat-stroked-button
          (click)="refreshDashboard()"
          [disabled]="loading()"
          class="!py-2">
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="flex justify-center items-center py-20">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading() && stats()" class="space-y-6">

    <!-- Sales Stats Cards -->
    <div>
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Sales Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Today -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-brand-sky cursor-help relative group hover:shadow-lg transition-shadow">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Today's Sales</p>
              <p class="text-2xl font-bold text-gray-900 mt-1">{{ formatCurrency(stats()!.salesStats.totalSalesToday) }}</p>
              <p class="text-xs text-gray-500 mt-1">{{ stats()!.salesStats.salesCountToday }} transactions</p>
            </div>
            <div class="p-3 bg-brand-sky/10 rounded-lg">
              <mat-icon class="text-brand-sky">today</mat-icon>
            </div>
          </div>
          <!-- Tooltip on hover -->
          <div class="absolute left-0 top-full mt-2 w-full bg-gray-900 text-white text-xs rounded-lg p-3 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
            <div class="space-y-1">
              <div class="flex justify-between">
                <span>Total Revenue:</span>
                <span class="text-brand-sky font-semibold">{{ formatCurrency(stats()!.salesStats.totalSalesToday) }}</span>
              </div>
              <div class="flex justify-between">
                <span>Transactions:</span>
                <span class="text-brand-sky font-semibold">{{ stats()!.salesStats.salesCountToday }}</span>
              </div>
              <div *ngIf="stats()!.salesStats.salesCountToday > 0" class="flex justify-between border-t border-gray-700 pt-1 mt-1">
                <span>Avg/Transaction:</span>
                <span class="text-brand-sky font-semibold">{{ formatCurrency(stats()!.salesStats.totalSalesToday / stats()!.salesStats.salesCountToday) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- This Week -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-brand-mint cursor-help relative group hover:shadow-lg transition-shadow">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">This Week</p>
              <p class="text-2xl font-bold text-gray-900 mt-1">{{ formatCurrency(stats()!.salesStats.totalSalesThisWeek) }}</p>
              <p class="text-xs text-gray-500 mt-1">{{ stats()!.salesStats.salesCountThisWeek }} transactions</p>
            </div>
            <div class="p-3 bg-brand-mint/10 rounded-lg">
              <mat-icon class="text-brand-mint">calendar_today</mat-icon>
            </div>
          </div>
          <!-- Tooltip on hover -->
          <div class="absolute left-0 top-full mt-2 w-full bg-gray-900 text-white text-xs rounded-lg p-3 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
            <div class="space-y-1">
              <div class="flex justify-between">
                <span>Total Revenue:</span>
                <span class="text-brand-mint font-semibold">{{ formatCurrency(stats()!.salesStats.totalSalesThisWeek) }}</span>
              </div>
              <div class="flex justify-between">
                <span>Transactions:</span>
                <span class="text-brand-mint font-semibold">{{ stats()!.salesStats.salesCountThisWeek }}</span>
              </div>
              <div *ngIf="stats()!.salesStats.salesCountThisWeek > 0" class="flex justify-between border-t border-gray-700 pt-1 mt-1">
                <span>Avg/Transaction:</span>
                <span class="text-brand-mint font-semibold">{{ formatCurrency(stats()!.salesStats.totalSalesThisWeek / stats()!.salesStats.salesCountThisWeek) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- This Month -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-brand-coral cursor-help relative group hover:shadow-lg transition-shadow">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">This Month</p>
              <p class="text-2xl font-bold text-gray-900 mt-1">{{ formatCurrency(stats()!.salesStats.totalSalesThisMonth) }}</p>
              <p class="text-xs text-gray-500 mt-1">{{ stats()!.salesStats.salesCountThisMonth}} transactions</p>
            </div>
            <div class="p-3 bg-brand-coral/10 rounded-lg">
              <mat-icon class="text-brand-coral">calendar_month</mat-icon>
            </div>
          </div>
          <!-- Tooltip on hover -->
          <div class="absolute left-0 top-full mt-2 w-full bg-gray-900 text-white text-xs rounded-lg p-3 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
            <div class="space-y-1">
              <div class="flex justify-between">
                <span>Total Revenue:</span>
                <span class="text-brand-coral font-semibold">{{ formatCurrency(stats()!.salesStats.totalSalesThisMonth) }}</span>
              </div>
              <div class="flex justify-between">
                <span>Transactions:</span>
                <span class="text-brand-coral font-semibold">{{ stats()!.salesStats.salesCountThisMonth }}</span>
              </div>
              <div class="flex justify-between">
                <span>Average Sale:</span>
                <span class="text-brand-coral font-semibold">{{ formatCurrency(stats()!.salesStats.averageSaleValue) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Average Sale -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500 cursor-help relative group hover:shadow-lg transition-shadow">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Average Sale</p>
              <p class="text-2xl font-bold text-gray-900 mt-1">{{ formatCurrency(stats()!.salesStats.averageSaleValue) }}</p>
              <p class="text-xs text-gray-500 mt-1">This month</p>
            </div>
            <div class="p-3 bg-purple-500/10 rounded-lg">
              <mat-icon class="text-purple-500">trending_up</mat-icon>
            </div>
          </div>
          <!-- Tooltip on hover -->
          <div class="absolute left-0 top-full mt-2 w-full bg-gray-900 text-white text-xs rounded-lg p-3 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
            <div class="space-y-1">
              <div class="flex justify-between">
                <span>This Month:</span>
                <span class="text-purple-300 font-semibold">{{ formatCurrency(stats()!.salesStats.averageSaleValue) }}</span>
              </div>
              <div class="flex justify-between text-[10px] text-gray-400 pt-1">
                <span>Based on {{ stats()!.salesStats.salesCountThisMonth }} transactions</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="bg-gradient-to-r from-brand-sky/10 to-brand-mint/10 rounded-lg  p-4 border border-brand-sky/20 transition-shadow cursor-pointer" (click)="navigateToReports()">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">Comprehensive Reports</h3>
          <p class="text-gray-600 ">
            View detailed reports on sales and inventory to make informed business decisions.
          </p>
        </div>
        <div class="flex-shrink-0 flex items-center gap-4">

          <button
            mat-raised-button
            class="!bg-brand-sky hover:!bg-brand-sky/90 !text-white !rounded-lg"
            (click)="navigateToReports()">
            <mat-icon>arrow_forward</mat-icon>
            View Reports
          </button>
        </div>
      </div>
    </div>


    <!-- Inventory & Credit Stats (moved above charts) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Inventory Stats -->
      <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold text-gray-900">Inventory Status</h3>
          <div class="p-2 bg-brand-mint/10 rounded-lg">
            <mat-icon class="text-brand-mint !text-2xl">inventory_2</mat-icon>
          </div>
        </div>

        <!-- Main Stats -->
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-gradient-to-br from-gray-50 to-white rounded-lg p-4 border border-gray-100">
            <p class="text-xs font-medium text-gray-600 uppercase tracking-wide">Total Products</p>
            <p class="text-2xl font-bold text-gray-900 mt-2">{{ stats()!.inventoryStats.totalProducts }}</p>
          </div>
          <div class="bg-gradient-to-br from-gray-50 to-white rounded-lg p-4 border border-gray-100">
            <p class="text-xs font-medium text-gray-600 uppercase tracking-wide">Stock Value</p>
            <p class="text-2xl font-bold text-gray-900 mt-2">{{ formatCurrency(stats()!.inventoryStats.totalStockValue) | slice:0:7 }}<span class="text-sm">k</span></p>
          </div>
        </div>

        <!-- Alert Stats -->
        <div class="space-y-3">
          <!-- Low Stock -->
          <div class="flex items-center justify-between p-4 rounded-lg bg-orange-50 border border-orange-100 cursor-help group relative">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-orange-100 rounded-lg">
                <mat-icon class="text-orange-600 !text-xl">error_outline</mat-icon>
              </div>
              <div>
                <p class="text-xs font-medium text-orange-700 uppercase tracking-wide">Low Stock</p>
                <p class="text-lg font-bold text-orange-900 mt-0.5">{{ stats()!.inventoryStats.lowStockCount }}</p>
              </div>
            </div>
            <!-- Tooltip on hover -->
            <div class="absolute left-0 top-full mt-2 w-72 bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
              <div class="font-semibold mb-2">Low Stock Products:</div>
              <div class="space-y-1 max-h-40 overflow-y-auto">
                <div *ngFor="let product of stats()!.lowStockProducts.slice(0, 5)" class="flex justify-between">
                  <span class="truncate">{{ product.productName }}</span>
                  <span class="ml-2 text-orange-300">{{ product.currentStock }}/{{ product.minStockLevel }}</span>
                </div>
                <div *ngIf="stats()!.lowStockProducts.length > 5" class="text-orange-300 italic pt-1">
                  +{{ stats()!.lowStockProducts.length - 5 }} more...
                </div>
              </div>
            </div>
          </div>

          <!-- Out of Stock -->
          <div class="flex items-center justify-between p-4 rounded-lg bg-red-50 border border-red-100">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-red-100 rounded-lg">
                <mat-icon class="text-red-600 !text-xl">block</mat-icon>
              </div>
              <div>
                <p class="text-xs font-medium text-red-700 uppercase tracking-wide">Out of Stock</p>
                <p class="text-lg font-bold text-red-900 mt-0.5">{{ stats()!.inventoryStats.outOfStockCount }}</p>
              </div>
            </div>
          </div>

          <!-- Expiring Soon -->
          <div class="flex items-center justify-between p-4 rounded-lg bg-yellow-50 border border-yellow-100">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-yellow-100 rounded-lg">
                <mat-icon class="text-yellow-600 !text-xl">schedule</mat-icon>
              </div>
              <div>
                <p class="text-xs font-medium text-yellow-700 uppercase tracking-wide">Expiring Soon</p>
                <p class="text-lg font-bold text-yellow-900 mt-0.5">{{ stats()!.inventoryStats.expiringWithin30Days }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Credit Stats -->
      <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold text-gray-900">Credit Accounts</h3>
          <div class="p-2 bg-brand-coral/10 rounded-lg">
            <mat-icon class="text-brand-coral !text-2xl">credit_card</mat-icon>
          </div>
        </div>

        <!-- Main Stat -->
        <div class="bg-gradient-to-br from-blue-50 to-white rounded-lg p-4 border border-blue-100 mb-6">
          <p class="text-xs font-medium text-blue-600 uppercase tracking-wide">Active Accounts</p>
          <p class="text-3xl font-bold text-blue-900 mt-2">{{ stats()!.creditStats.totalActiveCreditAccounts }}</p>
        </div>

        <!-- Alert Stats -->
        <div class="space-y-3">
          <!-- Outstanding -->
          <div class="flex items-center justify-between p-4 rounded-lg bg-indigo-50 border border-indigo-100">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-indigo-100 rounded-lg">
                <mat-icon class="text-indigo-600 !text-xl">account_balance_wallet</mat-icon>
              </div>
              <div>
                <p class="text-xs font-medium text-indigo-700 uppercase tracking-wide">Outstanding</p>
                <p class="text-sm font-bold text-indigo-900 mt-0.5">{{ formatCurrency(stats()!.creditStats.totalOutstandingAmount) | slice:0:11 }}</p>
              </div>
            </div>
          </div>

          <!-- Overdue -->
          <div class="flex items-center justify-between p-4 rounded-lg bg-orange-50 border border-orange-100 cursor-help group relative">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-orange-100 rounded-lg">
                <mat-icon class="text-orange-600 !text-xl">schedule</mat-icon>
              </div>
              <div>
                <p class="text-xs font-medium text-orange-700 uppercase tracking-wide">Overdue</p>
                <p class="text-lg font-bold text-orange-900 mt-0.5">{{ stats()!.creditStats.overdueAccounts }} <span class="text-xs font-normal">accounts</span></p>
              </div>
            </div>
            <!-- Tooltip on hover -->
            <div class="absolute left-0 top-full mt-2 w-64 bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
              <div class="font-semibold mb-1">Overdue Details:</div>
              <div class="flex justify-between">
                <span>Total Amount:</span>
                <span class="text-orange-300">{{ formatCurrency(stats()!.creditStats.overdueAmount) }}</span>
              </div>
              <div class="text-gray-300 text-[10px] mt-2">Past expected payment date</div>
            </div>
          </div>

          <!-- Payments This Month -->
          <div class="flex items-center justify-between p-4 rounded-lg bg-green-50 border border-green-100 cursor-help group relative">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-green-100 rounded-lg">
                <mat-icon class="text-green-600 !text-xl">check_circle</mat-icon>
              </div>
              <div>
                <p class="text-xs font-medium text-green-700 uppercase tracking-wide">Payments This Month</p>
                <p class="text-sm font-bold text-green-900 mt-0.5">{{ formatCurrency(stats()!.creditStats.paymentsReceivedThisMonth) | slice:0:11 }}</p>
              </div>
            </div>
            <!-- Tooltip on hover -->
            <div class="absolute left-0 top-full mt-2 w-56 bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
              <div class="space-y-1">
                <div class="flex justify-between">
                  <span>Today:</span>
                  <span class="text-green-300">{{ formatCurrency(stats()!.creditStats.paymentsReceivedToday) }}</span>
                </div>
                <div class="flex justify-between">
                  <span>This Week:</span>
                  <span class="text-green-300">{{ formatCurrency(stats()!.creditStats.paymentsReceivedThisWeek) }}</span>
                </div>
                <div class="flex justify-between font-semibold border-t border-gray-700 pt-1 mt-1">
                  <span>This Month:</span>
                  <span class="text-green-300">{{ formatCurrency(stats()!.creditStats.paymentsReceivedThisMonth) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Daily Revenue Chart -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
          <mat-icon class="text-brand-sky">show_chart</mat-icon>
          Daily Revenue (Last 30 Days)
        </h3>
        <div class="h-80">
          <ngx-charts-line-chart
            [results]="[{name: 'Revenue', series: dailyRevenueChart()}]"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            [xAxisLabel]="'Date'"
            [yAxisLabel]="'Revenue (KES)'"
            [scheme]="colorScheme">
          </ngx-charts-line-chart>
        </div>
      </div>

      <!-- Payment Method Distribution -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
          <mat-icon class="text-brand-sky">bar_chart</mat-icon>
          Monthly Revenue Trend
        </h3>
        <div class="h-96">
          <ngx-charts-bar-vertical
            [results]="monthlyRevenueChart()"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            [xAxisLabel]="'Month'"
            [yAxisLabel]="'Revenue (KES)'"
            [scheme]="colorScheme">
          </ngx-charts-bar-vertical>
        </div>
      </div>

    </div>

    <!-- Monthly Revenue Trend -->

    <!-- Recent Sales & Low Stock -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Recent Sales -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
          <mat-icon class="text-brand-sky">receipt</mat-icon>
          Recent Sales
        </h3>
        <div class="space-y-2">
          <div *ngFor="let sale of stats()!.recentSales" class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg">
            <div>
              <div class="font-medium text-gray-900">{{ sale.saleNumber }}</div>
              <div class="text-sm text-gray-500">{{ sale.customerName }}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold text-gray-900">{{ formatCurrency(sale.totalAmount) }}</div>
              <div class="text-xs text-gray-500">{{ sale.saleDate | date:'short' }}</div>
            </div>
          </div>
          <div *ngIf="stats()!.recentSales.length === 0" class="text-center py-8 text-gray-400">
            No recent sales
          </div>
        </div>
      </div>

      <!-- Low Stock Alerts -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
          <mat-icon class="text-orange-500">warning</mat-icon>
          Low Stock Alerts
        </h3>
        <div class="space-y-2">
          <div *ngFor="let product of stats()!.lowStockProducts" class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
            <div>
              <div class="font-medium text-gray-900">{{ product.productName }}</div>
              <div class="text-sm text-orange-600">Min: {{ product.minStockLevel }}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold text-orange-700">{{ product.currentStock }} left</div>
            </div>
          </div>
          <div *ngIf="stats()!.lowStockProducts.length === 0" class="text-center py-8 text-gray-400">
            All products well stocked
          </div>
        </div>
      </div>
    </div>


  </div>
</div>
